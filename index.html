<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Giá Pro - Cloud Final v2</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS (Excel) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ======================================================================================
        // THÔNG TIN KẾT NỐI CỦA ANH (ĐÃ ĐIỀN ĐÚNG)
        // ======================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAJ0v8t9h1PFCnHp3EtM70gy0jCV4Pgpfk",
            authDomain: "filegiasanpham.firebaseapp.com",
            projectId: "filegiasanpham",
            storageBucket: "filegiasanpham.firebasestorage.app",
            messagingSenderId: "444123574885",
            appId: "1:444123574885:web:dffd646b0f1b65b9e9cc8c"
        };
        // ======================================================================================

        window.isConfigured = !firebaseConfig.apiKey.includes("EXAMPLE");

        if (window.isConfigured) {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                window.db = db;
                window.firestore = { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy };
                console.log("Đã khởi tạo Firebase App!");
            } catch (e) {
                console.error("Lỗi khởi tạo Firebase:", e);
                window.isConfigured = false;
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        textarea { resize: none; overflow: hidden; min-height: 1.5em; }
        input[type="file"] { display: none; }
        .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000; max-height: 300px; overflow-y: auto; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 12px; }
        .suggestion-item:hover { background-color: #f3f4f6; }
        .suggestion-price { color: #ea580c; font-weight: bold; float: right; }
        @media print {
            @page { size: A4 landscape; margin: 0; }
            body { background-color: white; margin: 0; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print, .ui-control, .fixed-toolbar, .modal-overlay, .toast-noti, .suggestions-list, .delete-col { display: none !important; }
            .print-container { width: 100% !important; max-width: none !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: none !important; zoom: 100%; }
            table { page-break-inside: auto; border-collapse: collapse; width: 100%; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            .bg-orange-600 { background-color: #ea580c !important; color: white !important; }
            .bg-orange-100 { background-color: #ffedd5 !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Cloud: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            Trash2: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Plus: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Printer: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Upload: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            RefreshCcw: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>,
            Edit: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Eye: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Database: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Settings: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            AlertTriangle: ({size=40}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        };

        // --- FIREBASE HELPER ---
        const fbHelper = {
            getProducts: async () => {
                if(!window.isConfigured || !window.db) return [];
                try {
                    const q = window.firestore.query(window.firestore.collection(window.db, "products"), window.firestore.orderBy("TenSP"));
                    const snapshot = await window.firestore.getDocs(q);
                    return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (e) {
                    console.error("Lỗi lấy dữ liệu:", e);
                    // Check for "database not found" error
                    if (e.code === 'not-found' || e.message.includes('not-found') || e.message.includes('database (default) does not exist')) {
                        alert("LỖI: CHƯA TẠO DATABASE!\n\nAnh đã tạo Project nhưng chưa bấm nút 'Create Database' cho Firestore.\n\nVui lòng vào Firebase Console -> Build -> Firestore Database -> Bấm 'Create database' -> Chọn 'Start in test mode'.");
                    }
                    return [];
                }
            },
            batchAddProducts: async (products) => {
                if(!window.isConfigured || !window.db) return;
                try {
                    const promises = products.map(p => window.firestore.addDoc(window.firestore.collection(window.db, "products"), p));
                    await Promise.all(promises);
                } catch (e) {
                    console.error("Lỗi upload:", e);
                     if (e.code === 'not-found' || e.message.includes('not-found') || e.message.includes('database (default) does not exist')) {
                        alert("LỖI: CHƯA TẠO DATABASE!\n\nAnh đã tạo Project nhưng chưa bấm nút 'Create Database' cho Firestore.\n\nVui lòng vào Firebase Console -> Build -> Firestore Database -> Bấm 'Create database' -> Chọn 'Start in test mode'.");
                    } else {
                        alert("Lỗi upload: " + e.message);
                    }
                }
            },
            deleteProduct: async (id) => {
                if(!window.isConfigured || !window.db) return;
                try {
                    await window.firestore.deleteDoc(window.firestore.doc(window.db, "products", id));
                } catch (e) {
                     console.error("Lỗi xóa:", e);
                     alert("Lỗi xóa: " + e.message);
                }
            }
        };

        // --- COMPONENTS ---
        const SmartTextarea = ({ value, onChange, className, style, placeholder }) => {
            const ref = useRef(null);
            useEffect(() => { if (ref.current) { ref.current.style.height = 'auto'; ref.current.style.height = ref.current.scrollHeight + 'px'; } }, [value]);
            return <textarea ref={ref} value={value} onChange={onChange} className={className} style={{...style, height: 'auto', minHeight: '1.5em'}} placeholder={placeholder} rows={1} />;
        };

        const ConfigWarningModal = () => {
            if (window.isConfigured) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[300] p-4">
                    <div className="bg-white rounded-lg shadow-2xl max-w-lg w-full p-6 text-center">
                        <Icons.AlertTriangle size={60} className="mx-auto mb-4" />
                        <h2 className="text-xl font-bold text-gray-800 mb-2">Chưa kết nối Cơ Sở Dữ Liệu!</h2>
                        <p className="text-gray-600 mb-4 text-sm text-left">
                            Bạn đang dùng phiên bản "Cloud Online" nhưng chưa điền mã <b>firebaseConfig</b> của mình vào code. 
                            <br/><br/>
                            <b>Cách khắc phục:</b>
                            <ul className="list-disc pl-5 mt-1 space-y-1">
                                <li>Mở file <b>ToolBaoGia_Cloud_Final.html</b> bằng Notepad.</li>
                                <li>Tìm đoạn <code>const firebaseConfig = ...</code> ở gần đầu file.</li>
                                <li>Thay thế nó bằng config bạn lấy từ <b>Firebase Console</b> (Project Settings).</li>
                            </ul>
                        </p>
                        <p className="text-orange-600 font-bold text-sm">Các tính năng Online sẽ tạm khóa. Bạn vẫn có thể nhập liệu thủ công.</p>
                        <button onClick={() => {document.querySelector('.fixed.inset-0').style.display='none'}} className="mt-6 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded font-bold">Đóng & Dùng Offline</button>
                    </div>
                </div>
            );
        };

        const ProductManager = ({ isOpen, onClose, dbProducts, onReload }) => {
            const [uploading, setUploading] = useState(false);
            
            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setUploading(true);
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const workbook = XLSX.read(bstr, { type: 'binary' });
                        const wsname = workbook.SheetNames[0];
                        const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[wsname], { defval: "" });
                        
                        const getColumnName = (obj, possibilities) => {
                            const keys = Object.keys(obj);
                            for (let p of possibilities) if (keys.includes(p)) return p;
                            for (let key of keys) { const k = key.toLowerCase(); for (let p of possibilities) if (k.includes(p.toLowerCase())) return key; }
                            return null;
                        };

                        const normalizedData = jsonData.map(item => {
                            const nameKey = getColumnName(item, ['TenSP', 'Tên sản phẩm', 'Ten', 'Tên', 'Name', 'Model']);
                            const descKey = getColumnName(item, ['MoTa', 'Mô tả', 'Description', 'Thông số', 'Thông tin', 'Diễn giải']);
                            const brandKey = getColumnName(item, ['Hang', 'Hãng', 'Brand']);
                            const warKey = getColumnName(item, ['BaoHanh', 'Bảo hành', 'Warranty']);
                            const unitKey = getColumnName(item, ['DVT', 'ĐVT', 'Unit']);
                            let priceKey = Object.keys(item).find(k => k.toLowerCase().includes('gia') || k.toLowerCase().includes('price'));
                            if (!priceKey) priceKey = getColumnName(item, ['Gia', 'Giá', 'Price', 'Amount']);

                            if (!item[nameKey]) return null;

                            return {
                                TenSP: item[nameKey] || '',
                                MoTa: item[descKey] || '',
                                Hang: item[brandKey] || '',
                                BaoHanh: item[warKey] || 12,
                                DVT: item[unitKey] || 'Cái',
                                Gia: item[priceKey] || 0
                            };
                        }).filter(i => i);

                        if(window.isConfigured && confirm(`Tìm thấy ${normalizedData.length} sản phẩm. Đẩy lên Cloud?`)){
                            await fbHelper.batchAddProducts(normalizedData);
                            alert("Đã tải xong!");
                            onReload();
                        } else if (!window.isConfigured) {
                            alert("Chưa cấu hình Firebase! Không thể lưu lên Cloud.");
                        }
                    } catch (err) { alert("Lỗi: " + err.message); } finally { setUploading(false); }
                };
                reader.readAsBinaryString(file);
            };

            const handleDelete = async (id) => {
                if(confirm("Xóa sản phẩm này?")) {
                    await fbHelper.deleteProduct(id);
                    onReload();
                }
            }

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[80vh] flex flex-col">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 className="text-lg font-bold flex items-center gap-2"><Icons.Cloud /> Kho Sản Phẩm Online {window.isConfigured ? '(Đã kết nối)' : '(Offline)'}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800">✕</button>
                        </div>
                        <div className="p-4 bg-blue-50 text-sm text-blue-800">
                            {window.isConfigured ? "Danh sách này được đồng bộ Online." : "Bạn đang ở chế độ Offline. Vui lòng cấu hình Firebase để dùng tính năng này."}
                        </div>
                        {window.isConfigured && (
                            <div className="p-4 flex gap-2">
                                <label className={`flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded cursor-pointer ${uploading?'opacity-50':''}`}>
                                    {uploading ? 'Đang tải lên...' : 'Nạp Excel vào Cloud'}
                                    <input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} disabled={uploading} className="hidden"/>
                                </label>
                                <div className="text-xs text-gray-500 flex items-center ml-2">Tổng: {dbProducts.length} sản phẩm</div>
                            </div>
                        )}
                        <div className="flex-1 overflow-auto p-4">
                            <table className="w-full border-collapse border text-sm">
                                <thead className="bg-gray-100 sticky top-0">
                                    <tr><th className="border p-2 text-left">Tên SP</th><th className="border p-2 text-left">Giá</th><th className="border p-2 text-left">Hãng</th><th className="border p-2 w-10">Xóa</th></tr>
                                </thead>
                                <tbody>
                                    {dbProducts.map(p => (
                                        <tr key={p.id} className="hover:bg-gray-50">
                                            <td className="border p-2">{p.TenSP}</td>
                                            <td className="border p-2 font-bold text-orange-600">{new Intl.NumberFormat('vi-VN').format(p.Gia)}</td>
                                            <td className="border p-2">{p.Hang}</td>
                                            <td className="border p-2 text-center"><button onClick={() => handleDelete(p.id)} className="text-red-500 hover:bg-red-100 p-1 rounded"><Icons.Trash2 /></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductAutocomplete = ({ value, onChange, onSelectProduct, dbProducts, isPreviewMode, placeholder, className, style }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleInputChange = (e) => {
                const text = e.target.value;
                onChange(e);
                if (text.length > 0 && dbProducts.length > 0) {
                    const lowerText = text.toLowerCase();
                    const filtered = dbProducts.filter(p => (p.TenSP && String(p.TenSP).toLowerCase().includes(lowerText))).slice(0, 10);
                    setSuggestions(filtered);
                    setShowSuggestions(true);
                } else { setShowSuggestions(false); }
            };

            const handleSelectSuggestion = (item) => { onSelectProduct(item); setShowSuggestions(false); };

            if (isPreviewMode) return <div className={`${className} whitespace-pre-wrap`} style={style}>{value}</div>;

            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <SmartTextarea value={value} onChange={handleInputChange} className={`bg-blue-50/30 hover:bg-blue-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none w-full transition-colors ${className}`} style={style} placeholder={placeholder} />
                    {showSuggestions && suggestions.length > 0 && (
                        <div className="suggestions-list">
                            {suggestions.map((item, idx) => (
                                <div key={idx} className="suggestion-item" onClick={() => handleSelectSuggestion(item)}>
                                    <div className="font-bold">{item.TenSP}</div>
                                    <div className="text-gray-500 flex justify-between"><span>{item.Hang}</span><span className="suggestion-price">{new Intl.NumberFormat('vi-VN').format(item.Gia || 0)} đ</span></div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- MAIN APP ---
        const QuoteTool = () => {
            const [isPreviewMode, setIsPreviewMode] = useState(false);
            const [dbProducts, setDbProducts] = useState([]);
            const [showProductManager, setShowProductManager] = useState(false);
            const [data, setData] = useState({
                fileName: "Báo giá mới",
                projectTitle: "BÁO GIÁ_Smart Home",
                companyInfo: { logo: null, name: "CÔNG TY TNHH TM DV & XNK PHÚ THÁI", subName: "Smarthome Phú Thái - Nhà phân phối chính thức thiết bị nhà thông minh LUMI", address: "32 Đường số 4, Phường An Lạc, TP. Hồ Chí Minh", website: "smarthomephuthai.vn", hotline: "0908680247" },
                customerInfo: { companyName: "CÔNG TY TNHH TƯ VẤN THIẾT KẾ VÀ XÂY DỰNG NGUYÊN KHÁNH", mst: "316419615", address: "L18-11-13, Tầng 18, Tòa nhà Vincom Center Đồng Khởi, 72 Lê Thánh Tôn, P. Bến Nghé, Q.1, TP.HCM", contactName: "Anh Khánh", phone: "0911981618", quoteDate: new Date().toISOString().split('T')[0] },
                items: [{ id: 1, title: "(I) BỘ ĐIỀU KHIỂN TRUNG TÂM + ĐIỀU HÒA", products: [{ id: 101, name: "Bộ điều khiển trung tâm Camera Hub G3", description: "", image: null, brand: "AQARA", warranty: 18, qty: 1, unit: "Bộ", price: 3299000 }] }],
                financials: { discountType: 'amount', discountValue: 0, installationType: 'amount', installationValue: 11000000 }
            });

            const reloadProducts = async () => {
                if (window.isConfigured) {
                    const prods = await fbHelper.getProducts();
                    setDbProducts(prods);
                }
            };

            useEffect(() => { reloadProducts(); }, []);

            const handleFileUpload = (e, callback) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => callback(reader.result); reader.readAsDataURL(file); } };
            const handleAutoFillProduct = (catIdx, prodIdx, productData) => {
                const newData = {...data}; const prod = newData.items[catIdx].products[prodIdx];
                prod.name = productData.TenSP; prod.description = productData.MoTa; prod.brand = productData.Hang; prod.warranty = productData.BaoHanh; prod.unit = productData.DVT; prod.price = parseFloat(productData.Gia) || 0;
                setData(newData);
            };
            const calculateTotal = () => {
                let subtotal = 0; data.items.forEach(c => c.products.forEach(p => subtotal += p.qty * p.price));
                let discount = data.financials.discountType === 'percent' ? (subtotal * data.financials.discountValue) / 100 : data.financials.discountValue;
                let install = data.financials.installationType === 'percent' ? (subtotal * data.financials.installationValue) / 100 : data.financials.installationValue;
                return { subtotal, discount, install, total: (subtotal - discount) + install };
            };
            const totals = calculateTotal();
            const formatCurrency = (amt) => new Intl.NumberFormat('vi-VN').format(Math.round(amt));
            const handlePrint = () => { if (!isPreviewMode) { setIsPreviewMode(true); setTimeout(() => { document.title = data.fileName; window.print(); }, 500); } else { document.title = data.fileName; window.print(); } };
            const updateItem = (catIdx, prodIdx, field, val) => { const newData = {...data}; newData.items[catIdx].products[prodIdx][field] = val; setData(newData); };
            const addCategory = () => { const newData = {...data}; newData.items.push({ id: Date.now(), title: "(...) HẠNG MỤC MỚI", products: [] }); setData(newData); };
            const addProduct = (catIdx) => { const newData = {...data}; newData.items[catIdx].products.push({ id: Date.now(), name: "Sản phẩm mới", description: "", image: null, brand: "", warranty: 12, qty: 1, unit: "Cái", price: 0 }); setData(newData); };
            const removeCategory = (catIdx) => { if(confirm("Xóa mục này?")) { const newData = {...data}; newData.items.splice(catIdx, 1); setData(newData); } };
            const removeProduct = (catIdx, prodIdx) => { if(confirm("Xóa SP này?")) { const newData = {...data}; newData.items[catIdx].products.splice(prodIdx, 1); setData(newData); } };

            const renderEditable = (value, onChange, placeholder, className, isArea = false, style = {}) => {
                if (isPreviewMode) return <div className={`${className} whitespace-pre-wrap`} style={style}>{value}</div>;
                if (isArea) return <SmartTextarea value={value} onChange={onChange} className={`bg-blue-50/30 hover:bg-blue-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none w-full transition-colors ${className}`} style={style} placeholder={placeholder} />;
                return <input value={value} onChange={onChange} className={`bg-blue-50/30 hover:bg-blue-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none w-full transition-colors ${className}`} placeholder={placeholder} style={style} />;
            };

            return (
                <div className="min-h-screen p-4 pb-20 bg-gray-100">
                    <ConfigWarningModal />
                    <ProductManager isOpen={showProductManager} onClose={() => setShowProductManager(false)} dbProducts={dbProducts} onReload={reloadProducts} />

                    <div className="fixed-toolbar fixed top-0 left-0 right-0 bg-white shadow-md z-50 p-3 flex items-center justify-between border-b border-orange-200">
                        <div className="flex items-center gap-4">
                            <div className="font-bold text-orange-600 text-lg flex items-center gap-2"><Icons.Database /> Báo Giá Online (Firebase)</div>
                            <input value={data.fileName} onChange={(e) => setData({...data, fileName: e.target.value})} className="border-b border-gray-300 focus:border-orange-500 outline-none px-2 py-1 w-64 bg-transparent" placeholder="Tên file lưu..." />
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setShowProductManager(true)} className="flex items-center gap-2 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded shadow-sm font-medium">
                                <Icons.Settings /> Quản lý Sản Phẩm {window.isConfigured ? '' : '(Offline)'}
                            </button>
                            <button onClick={() => setIsPreviewMode(!isPreviewMode)} className={`flex items-center gap-2 px-4 py-2 text-white rounded shadow-sm font-medium transition-colors ${isPreviewMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-700'}`}>{isPreviewMode ? <><Icons.Edit /> Quay lại Sửa</> : <><Icons.Eye /> Xem & In</>}</button>
                            <button onClick={handlePrint} className="bg-orange-600 text-white px-4 py-2 rounded shadow hover:bg-orange-700 flex items-center gap-2"><Icons.Printer size={16}/> IN NGAY</button>
                        </div>
                    </div>

                    <div className={`mt-24 flex justify-center pb-10 print-container`}>
                        <div className="bg-white shadow-2xl relative border border-gray-200 print-container" style={{ width: '297mm', padding: '10mm', minHeight: '210mm' }}>
                            {/* HEADER */}
                            <div className="flex items-start gap-6 border-b-2 border-orange-600 pb-4 mb-4">
                                <div className="flex-shrink-0">
                                    <label className={`cursor-pointer group relative block w-48 h-24 border-2 rounded flex items-center justify-center overflow-hidden ${isPreviewMode ? 'border-transparent' : 'border-dashed border-gray-300 hover:border-orange-500'}`}>
                                        <input type="file" disabled={isPreviewMode} onChange={(e) => handleFileUpload(e, (base64) => setData({...data, companyInfo: {...data.companyInfo, logo: base64}}))} />
                                        {data.companyInfo.logo ? <img src={data.companyInfo.logo} className="w-full h-full object-contain" /> : !isPreviewMode && <div className="text-gray-400 text-center text-xs group-hover:text-orange-500 ui-control"><Icons.Upload size={24} /> <br/>Tải Logo</div>}
                                    </label>
                                </div>
                                <div className="flex-grow flex flex-col justify-center">
                                    {renderEditable(data.companyInfo.name, (e) => setData({...data, companyInfo: {...data.companyInfo, name: e.target.value}}), "Tên Công Ty", "font-black text-xl uppercase")}
                                    {renderEditable(data.companyInfo.subName, (e) => setData({...data, companyInfo: {...data.companyInfo, subName: e.target.value}}), "Mô tả phụ", "text-sm italic text-gray-600")}
                                    <div className="text-xs space-y-1 mt-1">
                                        <div className="flex"><strong className="w-24">Địa chỉ:</strong>{renderEditable(data.companyInfo.address, (e) => setData({...data, companyInfo: {...data.companyInfo, address: e.target.value}}), "", "flex-1")}</div>
                                        <div className="flex"><strong className="w-24">Liên hệ:</strong><div className="flex w-full"><span className="mr-1">Web:</span>{renderEditable(data.companyInfo.website, (e) => setData({...data, companyInfo: {...data.companyInfo, website: e.target.value}}), "", "mr-2")} <span className="mr-1">Hotline:</span>{renderEditable(data.companyInfo.hotline, (e) => setData({...data, companyInfo: {...data.companyInfo, hotline: e.target.value}}), "", "")}</div></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-end mb-6">
                                <div className="w-full pr-8">{renderEditable(data.projectTitle || "", (e) => setData({...data, projectTitle: e.target.value}), "TIÊU ĐỀ BÁO GIÁ", "text-3xl font-bold text-orange-600 uppercase")}</div>
                                <div className="text-right flex-shrink-0 text-xs text-gray-500 italic">Ngày báo giá: {new Date(data.customerInfo.quoteDate).toLocaleDateString('vi-VN')}</div>
                            </div>

                            <div className="grid grid-cols-2 gap-x-12 gap-y-2 text-xs mb-6">
                                <div><div className="flex mb-2 items-center"><span className="font-bold w-24 text-orange-700">Khách hàng:</span>{renderEditable(data.customerInfo.companyName, (e) => setData({...data, customerInfo: {...data.customerInfo, companyName: e.target.value}}), "", "flex-1 font-medium", true)}</div><div className="flex mb-2 items-center"><span className="font-bold w-24 text-orange-700">Địa chỉ:</span>{renderEditable(data.customerInfo.address, (e) => setData({...data, customerInfo: {...data.customerInfo, address: e.target.value}}), "", "flex-1", true)}</div></div>
                                <div><div className="flex mb-2 items-center"><span className="font-bold w-24 text-orange-700">Công ty:</span>{renderEditable(data.customerInfo.contactName, (e) => setData({...data, customerInfo: {...data.customerInfo, contactName: e.target.value}}), "", "flex-1")}</div><div className="flex mb-2 items-center"><div className="flex w-1/2 pr-2"><span className="font-bold w-16 text-orange-700">SĐT:</span>{renderEditable(data.customerInfo.phone, (e) => setData({...data, customerInfo: {...data.customerInfo, phone: e.target.value}}), "", "flex-1")}</div><div className="flex w-1/2 pl-2"><span className="font-bold w-10 text-orange-700">MST:</span>{renderEditable(data.customerInfo.mst, (e) => setData({...data, customerInfo: {...data.customerInfo, mst: e.target.value}}), "", "flex-1")}</div></div></div>
                            </div>
                            <div className="mb-4 text-xs italic text-gray-600">Smarthome Phú Thái xin chân thành cảm ơn Quý Khách đã quan tâm đến sản phẩm của chúng tôi, phúc đáp theo yêu cầu của Quý Khách chúng tôi xin gửi bảng báo giá như sau:</div>

                            <table className="w-full mb-8 border-collapse">
                                <thead>
                                    <tr>
                                        {["STT","Hình ảnh","Tên thiết bị / Mô tả tính năng","Hãng","BH(T)","SL","ĐVT","Đơn giá","Thành tiền"].map((h,i) => (<th key={i} className={`bg-orange-600 text-white font-bold text-[11px] py-2 uppercase border border-orange-600 ${i===1?'w-24':i===2?'':'w-auto'}`}>{h}</th>))}
                                        {!isPreviewMode && <th className="bg-gray-700 text-white font-bold text-[11px] py-2 uppercase border border-gray-700 w-10 delete-col">Xóa</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.items.map((cat, catIdx) => (
                                        <React.Fragment key={cat.id}>
                                            <tr className="bg-orange-100 break-inside-avoid">
                                                <td colSpan={!isPreviewMode ? 10 : 9} className="px-2 py-2 border-l border-r border-orange-200">
                                                    <div className="flex items-center gap-2 group">
                                                        <div className="flex-grow">{renderEditable(cat.title, (e) => {const d = {...data}; d.items[catIdx].title = e.target.value; setData(d)}, "", "font-bold text-orange-900 w-full uppercase")}</div>
                                                        {!isPreviewMode && (
                                                            <div className="flex-shrink-0 flex gap-1">
                                                                <button onClick={() => addProduct(catIdx)} className="bg-orange-600 text-white p-1 rounded hover:bg-orange-700" title="Thêm sản phẩm"><Icons.Plus size={14}/></button>
                                                                <button onClick={() => removeCategory(catIdx)} className="bg-red-500 text-white p-1 rounded hover:bg-red-600" title="Xóa hạng mục"><Icons.Trash2 size={14}/></button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            {cat.products.map((p, pIdx) => (
                                                <tr key={p.id} className="group hover:bg-orange-50 border-b border-l border-r border-gray-300 break-inside-avoid">
                                                    <td className="text-center text-gray-500 text-[11px] align-top py-2 relative w-10 p-0"><div className="w-full h-full flex items-center justify-center">{pIdx + 1}</div></td>
                                                    <td className="p-1 align-top w-24">
                                                        <div className={`w-24 h-20 flex justify-center mx-auto ${isPreviewMode ? '' : 'bg-gray-50 border border-gray-100'}`}>
                                                            <label className="cursor-pointer w-full h-full flex justify-center overflow-hidden">
                                                                <input type="file" disabled={isPreviewMode} onChange={(e) => handleFileUpload(e, (b64) => updateItem(catIdx, pIdx, 'image', b64))} />
                                                                {p.image ? <img src={p.image} className="w-full h-full object-contain" /> : !isPreviewMode && <div className="text-gray-300 flex flex-col items-center ui-control mt-4"><Icons.Upload size={14}/></div>}
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td className="px-2 pt-1 align-top">
                                                        <ProductAutocomplete value={p.name} onChange={(e) => updateItem(catIdx, pIdx, 'name', e.target.value)} onSelectProduct={(prodData) => handleAutoFillProduct(catIdx, pIdx, prodData)} dbProducts={dbProducts} isPreviewMode={isPreviewMode} placeholder="Nhập tên sản phẩm..." className="font-bold text-gray-800 text-[11px]" />
                                                        {renderEditable(p.description, (e) => updateItem(catIdx, pIdx, 'description', e.target.value), "Mô tả chi tiết...", "text-gray-500 text-[10px] mt-1 text-justify", true)}
                                                    </td>
                                                    <td className="px-1 pt-2 align-top w-20">{renderEditable(p.brand, (e) => updateItem(catIdx, pIdx, 'brand', e.target.value), "", "text-center uppercase font-semibold text-[11px]")}</td>
                                                    <td className="text-center pt-2 align-top w-16">{renderEditable(p.warranty, (e) => updateItem(catIdx, pIdx, 'warranty', e.target.value), "", "text-center text-[11px]")}</td>
                                                    <td className="text-center pt-2 align-top w-14">{renderEditable(p.qty, (e) => updateItem(catIdx, pIdx, 'qty', parseInt(e.target.value)||0), "0", "text-center font-bold text-[11px]")}</td>
                                                    <td className="text-center pt-2 align-top w-16">{renderEditable(p.unit, (e) => updateItem(catIdx, pIdx, 'unit', e.target.value), "", "text-center text-[11px]")}</td>
                                                    <td className="text-right px-2 font-medium pt-2 align-top w-28">{renderEditable(formatCurrency(p.price), (e) => updateItem(catIdx, pIdx, 'price', parseInt(e.target.value.replace(/[^0-9]/g,''))||0), "0", "text-right text-[11px]")}</td>
                                                    <td className="text-right px-2 font-bold text-orange-800 pt-2 align-top text-[11px] w-28">{formatCurrency(p.qty * p.price)}</td>
                                                    {!isPreviewMode && <td className="text-center pt-2 align-top w-10 delete-col bg-gray-50 border-gray-200"><button onClick={() => removeProduct(catIdx, pIdx)} className="text-red-400 hover:text-red-600 p-1 rounded transition-colors"><Icons.Trash2 size={16}/></button></td>}
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                            {!isPreviewMode && <div className="ui-control mt-4 text-center"><button onClick={addCategory} className="border border-dashed border-orange-400 text-orange-600 px-4 py-2 rounded text-xs hover:bg-orange-50"><Icons.Plus size={14}/> Thêm Hạng Mục</button></div>}
                            
                            {/* ... Phần Footer ... */}
                            <div className="flex mt-2 pt-2 gap-8 break-inside-avoid">
                                <div className="w-1/2 grid grid-cols-2 gap-4 text-[10px] text-gray-600">
                                    <div><h3 className="font-bold text-orange-700 mb-1">(1) Phí lắp đặt bao gồm:</h3><p>- Thi công phần cứng toàn bộ hệ thống Smarthome.</p><p>- Không bao gồm chi phí kéo dây điện, đục tường.</p><h3 className="font-bold text-orange-700 mb-1 mt-2">(2) Phí dịch vụ bao gồm:</h3><p>- Bảo hành tận nơi theo thời gian bảo hành sản phẩm.</p><p>- Kết nối toàn bộ hệ thống.</p><p>- Thiết kế hệ thống, Cấu hình tự động hóa.</p><p>- Chia phòng, đặt tên thiết bị, cấu hình tự động.</p><p>- Hướng dẫn khách hàng thao tác sử dụng.</p></div>
                                    <div><h3 className="font-bold text-orange-700 mb-1">THÔNG TIN THANH TOÁN:</h3><div className="mb-2"><p className="font-bold text-black">Tài khoản công ty:</p><p>STK: 060212148213 - Sacombank</p><p>CTK: CÔNG TY TNHH TM DV & XNK PHÚ THÁI</p></div><div><p className="font-bold text-black">Tài khoản cá nhân:</p><p>STK: 88129129 - ACB</p><p>CTK: Lý Ngọc Vân</p></div></div>
                                </div>
                                <div className="w-1/2 pl-12">
                                    <div className="flex justify-between py-1 border-b border-gray-100"><span className="font-bold text-gray-700">Tổng giá trị giải pháp:</span><span className="font-bold text-lg">{formatCurrency(totals.subtotal)} VNĐ</span></div>
                                    <div className="flex justify-between py-1 items-center border-b border-gray-100">
                                        <span className="text-gray-600 flex items-center gap-2">Chiết khấu: {!isPreviewMode && <button className="ui-control bg-gray-200 px-1 rounded hover:bg-gray-300" onClick={() => setData({...data, financials: {...data.financials, discountType: data.financials.discountType === 'amount' ? 'percent' : 'amount'}})}><Icons.RefreshCcw size={8}/> {data.financials.discountType === 'amount' ? 'Số tiền' : '%'}</button>}</span>
                                        <div className="flex items-center gap-1">{renderEditable(data.financials.discountType === 'amount' ? formatCurrency(data.financials.discountValue) : data.financials.discountValue, (e) => setData({...data, financials: {...data.financials, discountValue: parseInt(e.target.value.replace(/[^0-9]/g,''))||0}}), "0", "text-right text-red-500 font-medium w-24")} <span className="text-xs font-bold w-6">{data.financials.discountType === 'amount' ? 'VNĐ' : '%'}</span></div>
                                    </div>
                                    {data.financials.discountType === 'percent' && <div className="flex justify-end text-[10px] text-red-400 italic">- {formatCurrency(totals.discount)} VNĐ</div>}
                                    <div className="flex justify-between py-1 border-b border-gray-100"><span className="font-bold text-gray-700">Giá trị sau chiết khấu:</span><span className="font-bold text-orange-800">{formatCurrency(totals.subtotal - totals.discount)} VNĐ</span></div>
                                    <div className="flex justify-between py-1 items-center border-b border-gray-100">
                                        <span className="text-gray-600 flex items-center gap-2">Phí lắp đặt: {!isPreviewMode && <button className="ui-control bg-gray-200 px-1 rounded hover:bg-gray-300" onClick={() => setData({...data, financials: {...data.financials, installationType: data.financials.installationType === 'amount' ? 'percent' : 'amount'}})}><Icons.RefreshCcw size={8}/> {data.financials.installationType === 'amount' ? 'Số tiền' : '%'}</button>}</span>
                                        <div className="flex items-center gap-1">{renderEditable(data.financials.installationType === 'amount' ? formatCurrency(data.financials.installationValue) : data.financials.installationValue, (e) => setData({...data, financials: {...data.financials, installationValue: parseInt(e.target.value.replace(/[^0-9]/g,''))||0}}), "0", "text-right w-24")} <span className="text-xs w-6">{data.financials.installationType === 'amount' ? 'VNĐ' : '%'}</span></div>
                                    </div>
                                    {data.financials.installationType === 'percent' && <div className="flex justify-end text-[10px] text-gray-500 italic">+ {formatCurrency(totals.install)} VNĐ</div>}
                                    <div className="flex justify-between py-3 mt-2 bg-orange-600 text-white px-4 rounded-sm"><span className="font-bold uppercase text-sm">Tổng Thanh Toán:</span><span className="font-bold text-xl">{formatCurrency(totals.total)} VNĐ</span></div>
                                </div>
                            </div>
                            <div className="text-center text-[10px] text-gray-400 mt-6 italic border-t border-gray-100 pt-2">Báo giá có giá trị 2 tuần - Smarthome Phú Thái</div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<QuoteTool />);
    </script>
</body>
</html>
