<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Giá Pro - Chia Sẻ & Đồng Bộ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400&display=swap');

        body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
        
        textarea { resize: none; overflow: hidden; min-height: 1.5em; }
        input[type="file"] { display: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }

        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ddd; border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;
            max-height: 300px; overflow-y: auto;
        }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 12px; }
        .suggestion-item:hover { background-color: #f3f4f6; }
        .suggestion-price { color: #ea580c; font-weight: bold; float: right; }

        @media print {
            @page { size: A4 landscape; margin: 0; }
            body { background-color: white; margin: 0; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print, .ui-control, .fixed-toolbar, .modal-overlay, .toast-noti, .suggestions-list, .delete-col { display: none !important; }
            .print-container { width: 100% !important; max-width: none !important; margin: 0 !important; padding: 10mm !important; box-shadow: none !important; border: none !important; zoom: 100%; }
            table { page-break-inside: auto; border-collapse: collapse; width: 100%; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            .bg-orange-600 { background-color: #ea580c !important; color: white !important; }
            .bg-orange-100 { background-color: #ffedd5 !important; }
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Icons = {
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FolderOpen: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v2"/></svg>,
            Trash2: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Plus: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Printer: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Upload: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            RefreshCcw: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8"/><path d="M21 22v-6h-6"/><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"/></svg>,
            Database: ({size=20}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Check: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            AlertTriangle: ({size=40}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Eye: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Edit: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            FileSpreadsheet: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            FileDown: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 22h14a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v4"/><polyline points="14 2 14 8 20 8"/><path d="M3 15h6"/><path d="M6 12v6"/></svg>,
            DownloadCloud: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><polyline points="12 12 12 21"/><polyline points="8 17 12 21 16 17"/></svg>,
            UploadCloud: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><polyline points="12 12 12 21"/><line x1="12" y1="12" x2="12" y2="21"/><polyline points="16 16 12 12 8 16"/></svg>,
            FileJson: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>,
            Share: ({size=16}) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        };

        const DB_NAME = 'QuoteToolDB';
        const STORE_NAME = 'quotes';
        const DB_VERSION = 1;
        const dbHelper = {
            open: () => new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    if (!e.target.result.objectStoreNames.contains(STORE_NAME)) e.target.result.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            }),
            getAll: async () => {
                const db = await dbHelper.open();
                return new Promise((resolve) => {
                    const req = db.transaction([STORE_NAME], 'readonly').objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result);
                });
            },
            save: async (data) => {
                const db = await dbHelper.open();
                return new Promise((resolve) => {
                    const req = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).put(data);
                    req.onsuccess = () => resolve();
                });
            },
            delete: async (id) => {
                const db = await dbHelper.open();
                return new Promise((resolve) => {
                    const req = db.transaction([STORE_NAME], 'readwrite').objectStore(STORE_NAME).delete(id);
                    req.onsuccess = () => resolve();
                });
            }
        };

        // --- COMPONENTS ---
        const Toast = ({ message, show }) => (
            <div className={`toast-noti fixed bottom-4 right-4 bg-green-600 text-white px-6 py-3 rounded shadow-lg flex items-center gap-2 transition-opacity duration-300 z-[100] ${show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                <Icons.Check /> {message}
            </div>
        );

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, type = 'danger' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[200] modal-overlay animate-fade-in">
                    <div className="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
                        <div className="flex flex-col items-center text-center mb-4">
                            <Icons.AlertTriangle />
                            <h3 className="text-lg font-bold mt-2 text-gray-800">{title}</h3>
                            <p className="text-gray-600 text-sm mt-1">{message}</p>
                        </div>
                        <div className="flex gap-3 justify-center">
                            <button onClick={onCancel} className="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded font-medium">Hủy bỏ</button>
                            <button onClick={onConfirm} className={`px-4 py-2 text-white rounded font-medium ${type === 'danger' ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                {type === 'danger' ? 'Xóa ngay' : 'Đồng ý'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SmartTextarea = ({ value, onChange, className, style, placeholder }) => {
            const ref = useRef(null);
            useEffect(() => { if (ref.current) { ref.current.style.height = 'auto'; ref.current.style.height = ref.current.scrollHeight + 'px'; } }, [value]);
            return <textarea ref={ref} value={value} onChange={onChange} className={className} style={{...style, height: 'auto', minHeight: '1.5em'}} placeholder={placeholder} rows={1} />;
        };

        const ProductAutocomplete = ({ value, onChange, onSelectProduct, dbProducts, isPreviewMode, placeholder, className, style }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false);
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const handleInputChange = (e) => {
                const text = e.target.value;
                onChange(e);
                if (text.length > 0 && dbProducts.length > 0) {
                    const lowerText = text.toLowerCase();
                    const filtered = dbProducts.filter(p => (p.TenSP && String(p.TenSP).toLowerCase().includes(lowerText))).slice(0, 10);
                    setSuggestions(filtered);
                    setShowSuggestions(true);
                } else {
                    setShowSuggestions(false);
                }
            };

            const handleSelectSuggestion = (item) => {
                onSelectProduct(item);
                setShowSuggestions(false);
            };

            if (isPreviewMode) return <div className={`${className} whitespace-pre-wrap`} style={style}>{value}</div>;

            return (
                <div className="relative w-full" ref={wrapperRef}>
                    <SmartTextarea value={value} onChange={handleInputChange} className={`bg-blue-50/30 hover:bg-blue-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none w-full transition-colors ${className}`} style={style} placeholder={placeholder} />
                    {showSuggestions && suggestions.length > 0 && (
                        <div className="suggestions-list">
                            {suggestions.map((item, idx) => (
                                <div key={idx} className="suggestion-item" onClick={() => handleSelectSuggestion(item)}>
                                    <div className="font-bold">{item.TenSP}</div>
                                    <div className="text-gray-500 flex justify-between"><span>{item.Hang}</span><span className="suggestion-price">{new Intl.NumberFormat('vi-VN').format(item.Gia || 0)} đ</span></div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const QuoteTool = () => {
            const [savedFiles, setSavedFiles] = useState([]);
            const [showFileMenu, setShowFileMenu] = useState(false);
            const [toast, setToast] = useState({ show: false, message: '' });
            const [modal, setModal] = useState({ show: false, title: '', message: '', onConfirm: null, type: 'danger' });
            const [isPreviewMode, setIsPreviewMode] = useState(false);
            const [dbProducts, setDbProducts] = useState([]);

            const initialData = {
                id: null, fileName: "Báo giá A4 Ngang", projectTitle: "BÁO GIÁ_Smart Home",
                companyInfo: { logo: null, name: "CÔNG TY TNHH TM DV & XNK PHÚ THÁI", subName: "Smarthome Phú Thái - Nhà phân phối chính thức thiết bị nhà thông minh LUMI", address: "32 Đường số 4, Phường An Lạc, TP. Hồ Chí Minh", website: "smarthomephuthai.vn", hotline: "0908680247" },
                customerInfo: { companyName: "CÔNG TY TNHH TƯ VẤN THIẾT KẾ VÀ XÂY DỰNG NGUYÊN KHÁNH", mst: "316419615", address: "L18-11-13, Tầng 18, Tòa nhà Vincom Center Đồng Khởi, 72 Lê Thánh Tôn, P. Bến Nghé, Q.1, TP.HCM", contactName: "Anh Khánh", phone: "0911981618", quoteDate: new Date().toISOString().split('T')[0] },
                items: [{ id: 1, title: "(I) BỘ ĐIỀU KHIỂN TRUNG TÂM + ĐIỀU HÒA", products: [{ id: 101, name: "Bộ điều khiển trung tâm Camera Hub G3", description: "- Là bộ não của các thiết bị thông minh...\n- Camera 2K, nhận diện khuôn mặt.", image: null, brand: "AQARA", warranty: 18, qty: 1, unit: "Bộ", price: 3299000 }] }],
                financials: { discountType: 'amount', discountValue: 0, installationType: 'amount', installationValue: 11000000 }
            };

            const [data, setData] = useState(initialData);

            useEffect(() => { refreshSavedFiles(); }, []);

            const showToastMessage = (msg) => { setToast({ show: true, message: msg }); setTimeout(() => setToast({ show: false, message: '' }), 3000); };
            const refreshSavedFiles = async () => { try { const files = await dbHelper.getAll(); files.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified)); setSavedFiles(files); } catch (error) {} };
            const handleFileUpload = (e, callback) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onloadend = () => callback(reader.result); reader.readAsDataURL(file); } };

            const handleExcelUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const workbook = XLSX.read(bstr, { type: 'binary' });
                        const wsname = workbook.SheetNames[0];
                        const ws = workbook.Sheets[wsname];
                        const jsonData = XLSX.utils.sheet_to_json(ws, { defval: "" });
                        const getColumnName = (obj, possibilities) => {
                            const keys = Object.keys(obj);
                            for (let p of possibilities) if (keys.includes(p)) return p;
                            for (let key of keys) { const k = key.toLowerCase(); for (let p of possibilities) if (k.includes(p.toLowerCase())) return key; }
                            return null;
                        };
                        const normalizedData = jsonData.map(item => {
                            const newItem = {};
                            const nameKey = getColumnName(item, ['TenSP', 'Tên sản phẩm', 'Ten', 'Tên', 'Name', 'Model']);
                            const descKey = getColumnName(item, ['MoTa', 'Mô tả', 'Description', 'Thông số', 'Thông tin', 'Diễn giải', 'Chi tiết', 'Nội dung', 'Cấu hình']);
                            const brandKey = getColumnName(item, ['Hang', 'Hãng', 'Brand', 'NSX', 'Hiệu']);
                            const warKey = getColumnName(item, ['BaoHanh', 'Bảo hành', 'Warranty', 'BH']);
                            const unitKey = getColumnName(item, ['DVT', 'ĐVT', 'Unit', 'Đơn vị']);
                            let priceKey = Object.keys(item).find(k => { const nk = k.toLowerCase(); return (nk.includes('gia') || nk.includes('price')) && (nk.includes('ban') || nk.includes('le') || nk.includes('don')); });
                            if (!priceKey) priceKey = getColumnName(item, ['Gia', 'Giá', 'Price', 'Amount', 'Thành tiền']);
                            newItem.TenSP = item[nameKey] || ''; newItem.MoTa = item[descKey] || ''; newItem.Hang = item[brandKey] || ''; newItem.BaoHanh = item[warKey] || 12; newItem.DVT = item[unitKey] || 'Cái'; newItem.Gia = item[priceKey] || 0;
                            return newItem;
                        }).filter(i => i.TenSP);
                        setDbProducts(normalizedData);
                        showToastMessage(`Đã nhập thông minh ${normalizedData.length} SP!`);
                    } catch (err) { alert("Lỗi đọc file Excel: " + err.message); }
                };
                reader.readAsBinaryString(file);
            };

            const downloadSampleExcel = () => {
                const sampleData = [{ TenSP: "Bộ điều khiển trung tâm Aqara M2", MoTa: "Kết nối Zigbee 3.0, hỗ trợ Apple HomeKit", Hang: "AQARA", BaoHanh: 12, DVT: "Bộ", Gia: 1590000 }, { TenSP: "Công tắc thông minh Lumi 2 nút", MoTa: "Viền nhôm, mặt kính cường lực, kết nối Zigbee", Hang: "LUMI", BaoHanh: 24, DVT: "Cái", Gia: 1850000 }];
                const ws = XLSX.utils.json_to_sheet(sampleData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Danh_Sach_San_Pham");
                XLSX.writeFile(wb, "Mau_San_Pham_Bao_Gia.xlsx");
            };

            const handleAutoFillProduct = (catIdx, prodIdx, productData) => {
                const newData = {...data}; const prod = newData.items[catIdx].products[prodIdx];
                prod.name = productData.TenSP; prod.description = productData.MoTa; prod.brand = productData.Hang; prod.warranty = productData.BaoHanh; prod.unit = productData.DVT; prod.price = parseFloat(productData.Gia) || 0;
                setData(newData);
            };

            const calculateTotal = () => {
                let subtotal = 0; data.items.forEach(c => c.products.forEach(p => subtotal += p.qty * p.price));
                let discount = data.financials.discountType === 'percent' ? (subtotal * data.financials.discountValue) / 100 : data.financials.discountValue;
                let install = data.financials.installationType === 'percent' ? (subtotal * data.financials.installationValue) / 100 : data.financials.installationValue;
                return { subtotal, discount, install, total: (subtotal - discount) + install };
            };
            const totals = calculateTotal();
            const formatCurrency = (amt) => new Intl.NumberFormat('vi-VN').format(Math.round(amt));

            const handlePrint = () => { if (!isPreviewMode) { setIsPreviewMode(true); setTimeout(() => { document.title = data.fileName; window.print(); }, 500); } else { document.title = data.fileName; window.print(); } };
            const handleSave = async () => { try { const newFile = { ...data, lastModified: new Date().toISOString() }; if (!newFile.id) newFile.id = Date.now().toString(); await dbHelper.save(newFile); await refreshSavedFiles(); showToastMessage('Đã lưu thành công!'); } catch (e) { alert('Lỗi: ' + e.message); } };
            const requestDelete = (file, e) => { e.stopPropagation(); setModal({ show: true, title: 'Xóa File?', message: `Xóa vĩnh viễn file "${file.fileName}"?`, type: 'danger', onConfirm: async () => { await dbHelper.delete(file.id); await refreshSavedFiles(); setModal({ ...modal, show: false }); showToastMessage('Đã xóa file'); } }); };
            const requestLoad = (file) => { setModal({ show: true, title: 'Mở File?', message: `Mở file "${file.fileName}"?`, type: 'info', onConfirm: () => { setData(file); setShowFileMenu(false); setModal({ ...modal, show: false }); showToastMessage('Đã tải file lên'); } }); };
            const updateItem = (catIdx, prodIdx, field, val) => { const newData = {...data}; newData.items[catIdx].products[prodIdx][field] = val; setData(newData); };
            const requestRemoveCategory = (catIdx) => { setModal({ show: true, title: 'Xóa Hạng Mục?', message: 'Hạng mục này và toàn bộ sản phẩm bên trong sẽ bị xóa.', type: 'danger', onConfirm: () => { const newData = {...data}; newData.items.splice(catIdx, 1); setData(newData); setModal({...modal, show: false}); showToastMessage('Đã xóa hạng mục'); } }); };
            const requestRemoveProduct = (catIdx, prodIdx) => { setModal({ show: true, title: 'Xóa Sản Phẩm?', message: 'Bạn có chắc muốn xóa sản phẩm này?', type: 'danger', onConfirm: () => { const newData = {...data}; newData.items[catIdx].products.splice(prodIdx, 1); setData(newData); setModal({...modal, show: false}); showToastMessage('Đã xóa sản phẩm'); } }); };
            const addCategory = () => { const newData = {...data}; newData.items.push({ id: Date.now(), title: "(...) HẠNG MỤC MỚI", products: [] }); setData(newData); };
            const addProduct = (catIdx) => { const newData = {...data}; newData.items[catIdx].products.push({ id: Date.now(), name: "Sản phẩm mới", description: "", image: null, brand: "", warranty: 12, qty: 1, unit: "Cái", price: 0 }); setData(newData); };

            // --- TÍNH NĂNG MỚI: XUẤT/NHẬP FILE NGUỒN (JSON LẺ) ---
            const handleExportSingle = () => {
                const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${data.fileName.replace(/\s+/g, '_')}_Source.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToastMessage('Đã xuất file nguồn thành công!');
            };

            const handleImportSingle = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const importedData = JSON.parse(evt.target.result);
                        if (importedData.items && importedData.companyInfo) {
                            setData(importedData);
                            showToastMessage('Đã nhập báo giá thành công!');
                        } else {
                            alert('File không đúng định dạng báo giá!');
                        }
                    } catch (err) { alert('Lỗi đọc file: ' + err.message); }
                };
                reader.readAsText(file);
            };

            // BACKUP (Toàn bộ DB)
            const handleBackupData = async () => {
                const allData = await dbHelper.getAll();
                const blob = new Blob([JSON.stringify(allData)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Backup_FULL_DB_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                showToastMessage('Đã tải backup toàn bộ!');
            };

            const handleRestoreData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const restoredData = JSON.parse(event.target.result);
                        if (Array.isArray(restoredData)) {
                            for (const item of restoredData) await dbHelper.save(item);
                            await refreshSavedFiles();
                            showToastMessage("Đã khôi phục dữ liệu!");
                        } else { alert("File backup không hợp lệ."); }
                    } catch (err) { alert("Lỗi backup: " + err.message); }
                };
                reader.readAsText(file);
            };

            const renderEditable = (value, onChange, placeholder, className, isArea = false, style = {}) => {
                if (isPreviewMode) return <div className={`${className} whitespace-pre-wrap`} style={style}>{value}</div>;
                if (isArea) return <SmartTextarea value={value} onChange={onChange} className={`bg-blue-50/30 hover:bg-blue-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none w-full transition-colors ${className}`} style={style} placeholder={placeholder} />;
                return <input value={value} onChange={onChange} className={`bg-blue-50/30 hover:bg-blue-50 focus:bg-white focus:ring-1 ring-blue-300 outline-none w-full transition-colors ${className}`} placeholder={placeholder} style={style} />;
            };

            return (
                <div className="min-h-screen p-4 pb-20 bg-gray-100">
                    <Toast show={toast.show} message={toast.message} />
                    <ConfirmModal isOpen={modal.show} title={modal.title} message={modal.message} onConfirm={modal.onConfirm} onCancel={() => setModal({...modal, show: false})} type={modal.type} />

                    <div className="fixed-toolbar fixed top-0 left-0 right-0 bg-white shadow-md z-50 p-3 flex items-center justify-between border-b border-orange-200">
                        <div className="flex items-center gap-4">
                            <div className="font-bold text-orange-600 text-lg flex items-center gap-2"><Icons.Database /> Tool Báo Giá Share</div>
                            <input value={data.fileName} onChange={(e) => setData({...data, fileName: e.target.value})} className="border-b border-gray-300 focus:border-orange-500 outline-none px-2 py-1 w-64 bg-transparent" placeholder="Tên file lưu..." />
                        </div>
                        <div className="flex gap-2">
                            {/* NHẬP EXCEL */}
                            <div className="flex items-center gap-2 bg-white border border-gray-300 rounded p-1">
                                <label className="flex items-center gap-2 px-2 py-1 hover:bg-green-50 text-green-700 rounded cursor-pointer text-xs font-bold" title="Nhập danh sách sản phẩm từ Excel"><Icons.FileSpreadsheet /> Kho Data<input type="file" accept=".xlsx, .xls" onChange={handleExcelUpload} /></label>
                            </div>
                            
                            {/* CHIA SẺ & SAO LƯU */}
                            <div className="flex items-center gap-2 bg-blue-50 border border-blue-200 rounded p-1">
                                <button onClick={handleExportSingle} className="flex items-center gap-1 px-2 py-1 text-blue-600 hover:bg-blue-100 rounded text-xs font-bold" title="Xuất file này để gửi cho người khác"><Icons.Share /> Xuất File Nguồn</button>
                                <div className="w-px h-4 bg-blue-300"></div>
                                <label className="flex items-center gap-1 px-2 py-1 hover:bg-blue-100 text-blue-600 rounded cursor-pointer text-xs"><Icons.FileJson /> Mở File Nguồn<input type="file" accept=".json" onChange={handleImportSingle} /></label>
                            </div>

                            {/* QUẢN LÝ FILE LƯU TRONG MÁY */}
                            <div className="relative">
                                <button onClick={() => setShowFileMenu(!showFileMenu)} className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded text-gray-700 border border-gray-300"><Icons.FolderOpen /> Mở Lưu ({savedFiles.length})</button>
                                {showFileMenu && (
                                    <div className="absolute top-full right-0 mt-2 w-80 bg-white shadow-xl rounded border border-gray-200 max-h-96 overflow-y-auto z-50">
                                        <div className="p-2 border-b flex justify-between bg-gray-50 text-xs text-gray-500">
                                            <span>Danh sách đã lưu</span>
                                            <div className="flex gap-2">
                                                <button onClick={handleBackupData} className="hover:text-blue-600">Backup Tất Cả</button>
                                                <label className="cursor-pointer hover:text-blue-600">Restore<input type="file" className="hidden" accept=".json" onChange={handleRestoreData}/></label>
                                            </div>
                                        </div>
                                        {savedFiles.map(file => (
                                            <div key={file.id} onClick={() => requestLoad(file)} className="p-3 hover:bg-orange-50 cursor-pointer border-b flex justify-between items-center group">
                                                <div className="overflow-hidden"><div className="font-bold text-gray-800 truncate">{file.fileName}</div><div className="text-xs text-gray-400">{new Date(file.lastModified).toLocaleDateString('vi-VN')}</div></div>
                                                <button onClick={(e) => requestDelete(file, e)} className="text-red-400 hover:text-white hover:bg-red-500 p-2 rounded"><Icons.Trash2 /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            <button onClick={handleSave} className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow-sm font-medium"><Icons.Save /> Lưu</button>
                            <button onClick={() => setIsPreviewMode(!isPreviewMode)} className={`flex items-center gap-2 px-4 py-2 text-white rounded shadow-sm font-medium transition-colors ${isPreviewMode ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 hover:bg-gray-700'}`}>{isPreviewMode ? <><Icons.Edit /> Quay lại Sửa</> : <><Icons.Eye /> Xem & In</>}</button>
                        </div>
                    </div>

                    {isPreviewMode && (
                        <div className="fixed-toolbar fixed top-16 left-0 right-0 bg-blue-100 text-blue-800 px-4 py-2 text-center text-sm font-bold z-40 shadow-sm border-b border-blue-200 flex justify-center items-center gap-4">
                            <span>ĐANG Ở CHẾ ĐỘ XEM TRƯỚC. GIAO DIỆN NÀY SẼ GIỐNG HỆT KHI IN.</span>
                            <button onClick={handlePrint} className="bg-orange-600 text-white px-4 py-1 rounded shadow hover:bg-orange-700 flex items-center gap-2"><Icons.Printer size={16}/> IN NGAY (Ctrl + P)</button>
                        </div>
                    )}

                    <div className={`mt-24 flex justify-center pb-10 print-container`}>
                        <div className="bg-white shadow-2xl relative border border-gray-200 print-container" style={{ width: '297mm', padding: '10mm', minHeight: '210mm' }}>
                            {/* HEADER */}
                            <div className="flex items-start gap-6 border-b-2 border-orange-600 pb-4 mb-4">
                                <div className="flex-shrink-0">
                                    <label className={`cursor-pointer group relative block w-48 h-24 border-2 rounded flex items-center justify-center overflow-hidden ${isPreviewMode ? 'border-transparent' : 'border-dashed border-gray-300 hover:border-orange-500'}`}>
                                        <input type="file" disabled={isPreviewMode} onChange={(e) => handleFileUpload(e, (base64) => setData({...data, companyInfo: {...data.companyInfo, logo: base64}}))} />
                                        {data.companyInfo.logo ? <img src={data.companyInfo.logo} className="w-full h-full object-contain" /> : !isPreviewMode && <div className="text-gray-400 text-center text-xs group-hover:text-orange-500 ui-control"><Icons.Upload size={24} /> <br/>Tải Logo</div>}
                                    </label>
                                </div>
                                <div className="flex-grow flex flex-col justify-center">
                                    {renderEditable(data.companyInfo.name, (e) => setData({...data, companyInfo: {...data.companyInfo, name: e.target.value}}), "Tên Công Ty", "font-black text-xl uppercase")}
                                    {renderEditable(data.companyInfo.subName, (e) => setData({...data, companyInfo: {...data.companyInfo, subName: e.target.value}}), "Mô tả phụ", "text-sm italic text-gray-600")}
                                    <div className="text-xs space-y-1 mt-1">
                                        <div className="flex"><strong className="w-24">Địa chỉ:</strong>{renderEditable(data.companyInfo.address, (e) => setData({...data, companyInfo: {...data.companyInfo, address: e.target.value}}), "", "flex-1")}</div>
                                        <div className="flex"><strong className="w-24">Liên hệ:</strong><div className="flex w-full"><span className="mr-1">Web:</span>{renderEditable(data.companyInfo.website, (e) => setData({...data, companyInfo: {...data.companyInfo, website: e.target.value}}), "", "mr-2")} <span className="mr-1">Hotline:</span>{renderEditable(data.companyInfo.hotline, (e) => setData({...data, companyInfo: {...data.companyInfo, hotline: e.target.value}}), "", "")}</div></div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex justify-between items-end mb-6">
                                <div className="w-full pr-8">{renderEditable(data.projectTitle || "", (e) => setData({...data, projectTitle: e.target.value}), "TIÊU ĐỀ BÁO GIÁ", "text-3xl font-bold text-orange-600 uppercase")}</div>
                                <div className="text-right flex-shrink-0 text-xs text-gray-500 italic">Ngày báo giá: {new Date(data.customerInfo.quoteDate).toLocaleDateString('vi-VN')}</div>
                            </div>

                            <div className="grid grid-cols-2 gap-x-12 gap-y-2 text-xs mb-6">
                                <div><div className="flex mb-2 items-center"><span className="font-bold w-24 text-orange-700">Khách hàng:</span>{renderEditable(data.customerInfo.companyName, (e) => setData({...data, customerInfo: {...data.customerInfo, companyName: e.target.value}}), "", "flex-1 font-medium", true)}</div><div className="flex mb-2 items-center"><span className="font-bold w-24 text-orange-700">Địa chỉ:</span>{renderEditable(data.customerInfo.address, (e) => setData({...data, customerInfo: {...data.customerInfo, address: e.target.value}}), "", "flex-1", true)}</div></div>
                                <div><div className="flex mb-2 items-center"><span className="font-bold w-24 text-orange-700">Công ty:</span>{renderEditable(data.customerInfo.contactName, (e) => setData({...data, customerInfo: {...data.customerInfo, contactName: e.target.value}}), "", "flex-1")}</div><div className="flex mb-2 items-center"><div className="flex w-1/2 pr-2"><span className="font-bold w-16 text-orange-700">SĐT:</span>{renderEditable(data.customerInfo.phone, (e) => setData({...data, customerInfo: {...data.customerInfo, phone: e.target.value}}), "", "flex-1")}</div><div className="flex w-1/2 pl-2"><span className="font-bold w-10 text-orange-700">MST:</span>{renderEditable(data.customerInfo.mst, (e) => setData({...data, customerInfo: {...data.customerInfo, mst: e.target.value}}), "", "flex-1")}</div></div></div>
                            </div>
                            <div className="mb-4 text-xs italic text-gray-600">Smarthome Phú Thái xin chân thành cảm ơn Quý Khách đã quan tâm đến sản phẩm của chúng tôi, phúc đáp theo yêu cầu của Quý Khách chúng tôi xin gửi bảng báo giá như sau:</div>

                            <table className="w-full mb-8 border-collapse">
                                <thead>
                                    <tr>
                                        {["STT","Hình ảnh","Tên thiết bị / Mô tả tính năng","Hãng","BH(T)","SL","ĐVT","Đơn giá","Thành tiền"].map((h,i) => (<th key={i} className={`bg-orange-600 text-white font-bold text-[11px] py-2 uppercase border border-orange-600 ${i===1?'w-24':i===2?'':'w-auto'}`}>{h}</th>))}
                                        {!isPreviewMode && <th className="bg-gray-700 text-white font-bold text-[11px] py-2 uppercase border border-gray-700 w-10 delete-col">Xóa</th>}
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.items.map((cat, catIdx) => (
                                        <React.Fragment key={cat.id}>
                                            <tr className="bg-orange-100 break-inside-avoid">
                                                <td colSpan={!isPreviewMode ? 10 : 9} className="px-2 py-2 border-l border-r border-orange-200">
                                                    <div className="flex items-center gap-2 group">
                                                        <div className="flex-grow">{renderEditable(cat.title, (e) => {const d = {...data}; d.items[catIdx].title = e.target.value; setData(d)}, "", "font-bold text-orange-900 w-full uppercase")}</div>
                                                        {!isPreviewMode && (
                                                            <div className="flex-shrink-0 flex gap-1">
                                                                <button onClick={() => addProduct(catIdx)} className="bg-orange-600 text-white p-1 rounded hover:bg-orange-700" title="Thêm sản phẩm"><Icons.Plus size={14}/></button>
                                                                <button onClick={() => requestRemoveCategory(catIdx)} className="bg-red-500 text-white p-1 rounded hover:bg-red-600" title="Xóa hạng mục"><Icons.Trash2 size={14}/></button>
                                                            </div>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                            {cat.products.map((p, pIdx) => (
                                                <tr key={p.id} className="group hover:bg-orange-50 border-b border-l border-r border-gray-300 break-inside-avoid">
                                                    <td className="text-center text-gray-500 text-[11px] align-top py-2 relative w-10 p-0">
                                                        <div className="w-full h-full flex items-center justify-center">
                                                            {pIdx + 1}
                                                        </div>
                                                    </td>
                                                    <td className="p-1 align-top w-24">
                                                        <div className={`w-24 h-20 flex justify-center mx-auto ${isPreviewMode ? '' : 'bg-gray-50 border border-gray-100'}`}>
                                                            <label className="cursor-pointer w-full h-full flex justify-center overflow-hidden">
                                                                <input type="file" disabled={isPreviewMode} onChange={(e) => handleFileUpload(e, (b64) => updateItem(catIdx, pIdx, 'image', b64))} />
                                                                {p.image ? <img src={p.image} className="w-full h-full object-contain" /> : !isPreviewMode && <div className="text-gray-300 flex flex-col items-center ui-control mt-4"><Icons.Upload size={14}/></div>}
                                                            </label>
                                                        </div>
                                                    </td>
                                                    <td className="px-2 pt-1 align-top">
                                                        <ProductAutocomplete value={p.name} onChange={(e) => updateItem(catIdx, pIdx, 'name', e.target.value)} onSelectProduct={(prodData) => handleAutoFillProduct(catIdx, pIdx, prodData)} dbProducts={dbProducts} isPreviewMode={isPreviewMode} placeholder="Nhập tên sản phẩm..." className="font-bold text-gray-800 text-[11px]" />
                                                        {renderEditable(p.description, (e) => updateItem(catIdx, pIdx, 'description', e.target.value), "Mô tả chi tiết...", "text-gray-500 text-[10px] mt-1 text-justify", true)}
                                                    </td>
                                                    <td className="px-1 pt-2 align-top w-20">{renderEditable(p.brand, (e) => updateItem(catIdx, pIdx, 'brand', e.target.value), "", "text-center uppercase font-semibold text-[11px]")}</td>
                                                    <td className="text-center pt-2 align-top w-16">{renderEditable(p.warranty, (e) => updateItem(catIdx, pIdx, 'warranty', e.target.value), "", "text-center text-[11px]")}</td>
                                                    <td className="text-center pt-2 align-top w-14">{renderEditable(p.qty, (e) => updateItem(catIdx, pIdx, 'qty', parseInt(e.target.value)||0), "0", "text-center font-bold text-[11px]")}</td>
                                                    <td className="text-center pt-2 align-top w-16">{renderEditable(p.unit, (e) => updateItem(catIdx, pIdx, 'unit', e.target.value), "", "text-center text-[11px]")}</td>
                                                    <td className="text-right px-2 font-medium pt-2 align-top w-28">{renderEditable(formatCurrency(p.price), (e) => updateItem(catIdx, pIdx, 'price', parseInt(e.target.value.replace(/[^0-9]/g,''))||0), "0", "text-right text-[11px]")}</td>
                                                    <td className="text-right px-2 font-bold text-orange-800 pt-2 align-top text-[11px] w-28">{formatCurrency(p.qty * p.price)}</td>
                                                    
                                                    {!isPreviewMode && (
                                                        <td className="text-center pt-2 align-top w-10 delete-col bg-gray-50 border-gray-200">
                                                            <button onClick={() => requestRemoveProduct(catIdx, pIdx)} className="text-red-400 hover:text-red-600 p-1 rounded transition-colors" title="Xóa dòng này">
                                                                <Icons.Trash2 size={16}/>
                                                            </button>
                                                        </td>
                                                    )}
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                            
                            {!isPreviewMode && <div className="ui-control mt-4 text-center"><button onClick={addCategory} className="border border-dashed border-orange-400 text-orange-600 px-4 py-2 rounded text-xs hover:bg-orange-50"><Icons.Plus size={14}/> Thêm Hạng Mục</button></div>}

                            <div className="flex mt-2 pt-2 gap-8 break-inside-avoid">
                                <div className="w-1/2 grid grid-cols-2 gap-4 text-[10px] text-gray-600">
                                    <div>
                                        <h3 className="font-bold text-orange-700 mb-1">(1) Phí lắp đặt bao gồm:</h3>
                                        <p>- Thi công phần cứng toàn bộ hệ thống Smarthome.</p>
                                        <p>- Không bao gồm chi phí kéo dây điện, đục tường.</p>
                                        <h3 className="font-bold text-orange-700 mb-1 mt-2">(2) Phí dịch vụ bao gồm:</h3>
                                        <p>- Bảo hành tận nơi theo thời gian bảo hành sản phẩm ghi trên báo giá sau khi nghiệm thu hoàn tất.</p>
                                        <p>- Kết nối toàn bộ hệ thống.</p>
                                        <p>- Thiết kế hệ thống, Cấu hình tự động hóa các thiết bị liên kết với nhau.</p>
                                        <p>- Chia phòng, đặt tên thiết bị, cấu hình tự động cho từng phòng.</p>
                                        <p>- Hướng dẫn khách hàng thao tác sử dụng trên máy tính, điện thoại.</p>
                                    </div>
                                    <div><h3 className="font-bold text-orange-700 mb-1">THÔNG TIN THANH TOÁN:</h3><div className="mb-2"><p className="font-bold text-black">Tài khoản công ty:</p><p>STK: 060212148213 - Sacombank</p><p>CTK: CÔNG TY TNHH TM DV & XNK PHÚ THÁI</p></div><div><p className="font-bold text-black">Tài khoản cá nhân:</p><p>STK: 88129129 - ACB</p><p>CTK: Lý Ngọc Vân</p></div></div>
                                </div>
                                <div className="w-1/2 pl-12">
                                    <div className="flex justify-between py-1 border-b border-gray-100"><span className="font-bold text-gray-700">Tổng giá trị giải pháp:</span><span className="font-bold text-lg">{formatCurrency(totals.subtotal)} VNĐ</span></div>
                                    <div className="flex justify-between py-1 items-center border-b border-gray-100">
                                        <span className="text-gray-600 flex items-center gap-2">Chiết khấu: {!isPreviewMode && <button className="ui-control bg-gray-200 px-1 rounded hover:bg-gray-300" onClick={() => setData({...data, financials: {...data.financials, discountType: data.financials.discountType === 'amount' ? 'percent' : 'amount'}})}><Icons.RefreshCcw size={8}/> {data.financials.discountType === 'amount' ? 'Số tiền' : '%'}</button>}</span>
                                        <div className="flex items-center gap-1">{renderEditable(data.financials.discountType === 'amount' ? formatCurrency(data.financials.discountValue) : data.financials.discountValue, (e) => setData({...data, financials: {...data.financials, discountValue: parseInt(e.target.value.replace(/[^0-9]/g,''))||0}}), "0", "text-right text-red-500 font-medium w-24")} <span className="text-xs font-bold w-6">{data.financials.discountType === 'amount' ? 'VNĐ' : '%'}</span></div>
                                    </div>
                                    {data.financials.discountType === 'percent' && <div className="flex justify-end text-[10px] text-red-400 italic">- {formatCurrency(totals.discount)} VNĐ</div>}
                                    <div className="flex justify-between py-1 border-b border-gray-100"><span className="font-bold text-gray-700">Giá trị sau chiết khấu:</span><span className="font-bold text-orange-800">{formatCurrency(totals.subtotal - totals.discount)} VNĐ</span></div>
                                    <div className="flex justify-between py-1 items-center border-b border-gray-100">
                                        <span className="text-gray-600 flex items-center gap-2">Phí lắp đặt: {!isPreviewMode && <button className="ui-control bg-gray-200 px-1 rounded hover:bg-gray-300" onClick={() => setData({...data, financials: {...data.financials, installationType: data.financials.installationType === 'amount' ? 'percent' : 'amount'}})}><Icons.RefreshCcw size={8}/> {data.financials.installationType === 'amount' ? 'Số tiền' : '%'}</button>}</span>
                                        <div className="flex items-center gap-1">{renderEditable(data.financials.installationType === 'amount' ? formatCurrency(data.financials.installationValue) : data.financials.installationValue, (e) => setData({...data, financials: {...data.financials, installationValue: parseInt(e.target.value.replace(/[^0-9]/g,''))||0}}), "0", "text-right w-24")} <span className="text-xs w-6">{data.financials.installationType === 'amount' ? 'VNĐ' : '%'}</span></div>
                                    </div>
                                    {data.financials.installationType === 'percent' && <div className="flex justify-end text-[10px] text-gray-500 italic">+ {formatCurrency(totals.install)} VNĐ</div>}
                                    <div className="flex justify-between py-3 mt-2 bg-orange-600 text-white px-4 rounded-sm"><span className="font-bold uppercase text-sm">Tổng Thanh Toán:</span><span className="font-bold text-xl">{formatCurrency(totals.total)} VNĐ</span></div>
                                </div>
                            </div>
                            <div className="text-center text-[10px] text-gray-400 mt-6 italic border-t border-gray-100 pt-2">Báo giá có giá trị 2 tuần - Smarthome Phú Thái</div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<QuoteTool />);
    </script>
</body>
</html>